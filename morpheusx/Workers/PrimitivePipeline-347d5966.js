define(["exports","./Transforms-62a339c3","./ComponentDatatype-9ed50558","./when-8166c7dd","./RuntimeError-4fdc4459","./Matrix2-92b7fb9d","./GeometryAttribute-6f4c3b93","./GeometryAttributes-50becc99","./GeometryPipeline-54fb0bb4","./IndexDatatype-797210ca","./WebMercatorProjection-6ac42c0a"],(function(e,t,r,n,i,o,a,s,d,p,f){"use strict";function u(e,t,r){e=n.defaultValue(e,0),t=n.defaultValue(t,0),r=n.defaultValue(r,0),this.value=new Float32Array([e,t,r])}function c(e,t,r){var i,a=!r,s=e.length;if(!a&&s>1){var p=e[0].modelMatrix;for(i=1;i<s;++i)if(!o.Matrix4.equals(p,e[i].modelMatrix)){a=!0;break}}if(a)for(i=0;i<s;++i)n.defined(e[i].geometry)&&d.GeometryPipeline.transformToWorldCoordinates(e[i]);else o.Matrix4.multiplyTransformation(t,e[0].modelMatrix,t)}function m(e,t){var n=e.attributes,i=n.position,o=i.values.length/i.componentsPerAttribute;n.batchId=new a.GeometryAttribute({componentDatatype:r.ComponentDatatype.FLOAT,componentsPerAttribute:1,values:new Float32Array(o)});for(var s=n.batchId.values,d=0;d<o;++d)s[d]=t}function h(e){for(var t=e.length,r=0;r<t;++r){var i=e[r];n.defined(i.geometry)?m(i.geometry,r):n.defined(i.westHemisphereGeometry)&&n.defined(i.eastHemisphereGeometry)&&(m(i.westHemisphereGeometry,r),m(i.eastHemisphereGeometry,r))}}function l(e){var o,a,s,p=e.instances,f=e.projection,u=e.elementIndexUintSupported,m=e.scene3DOnly,l=e.vertexCacheOptimize,g=e.compressVertices,y=e.modelMatrix,v=p.length;for(o=0;o<v;++o)if(n.defined(p[o].geometry)){s=p[o].geometry.primitiveType;break}for(o=1;o<v;++o)if(n.defined(p[o].geometry)&&p[o].geometry.primitiveType!==s)throw new i.DeveloperError("All instance geometries must have the same primitiveType.");if(c(p,y,m),!m)for(o=0;o<v;++o)n.defined(p[o].geometry)&&d.GeometryPipeline.splitLongitude(p[o]);if(h(p),l)for(o=0;o<v;++o){var b=p[o];n.defined(b.geometry)?(d.GeometryPipeline.reorderForPostVertexCache(b.geometry),d.GeometryPipeline.reorderForPreVertexCache(b.geometry)):n.defined(b.westHemisphereGeometry)&&n.defined(b.eastHemisphereGeometry)&&(d.GeometryPipeline.reorderForPostVertexCache(b.westHemisphereGeometry),d.GeometryPipeline.reorderForPreVertexCache(b.westHemisphereGeometry),d.GeometryPipeline.reorderForPostVertexCache(b.eastHemisphereGeometry),d.GeometryPipeline.reorderForPreVertexCache(b.eastHemisphereGeometry))}var x=d.GeometryPipeline.combineInstances(p);for(v=x.length,o=0;o<v;++o){a=x[o];var G,S=a.attributes;if(m)for(G in S)S.hasOwnProperty(G)&&S[G].componentDatatype===r.ComponentDatatype.DOUBLE&&d.GeometryPipeline.encodeAttribute(a,G,G+"3DHigh",G+"3DLow");else for(G in S)if(S.hasOwnProperty(G)&&S[G].componentDatatype===r.ComponentDatatype.DOUBLE){var P=G+"3D",k=G+"2D";d.GeometryPipeline.projectTo2D(a,G,P,k,f),n.defined(a.boundingSphere)&&"position"===G&&(a.boundingSphereCV=t.BoundingSphere.fromVertices(a.attributes.position2D.values)),d.GeometryPipeline.encodeAttribute(a,P,P+"High",P+"Low"),d.GeometryPipeline.encodeAttribute(a,k,k+"High",k+"Low")}g&&d.GeometryPipeline.compressVertices(a)}if(!u){var C=[];for(v=x.length,o=0;o<v;++o)a=x[o],C=C.concat(d.GeometryPipeline.fitToUnsignedShortIndices(a));x=C}return x}function g(e,t,r,i){var o,a,s,d=i.length-1;if(d>=0){var p=i[d];o=p.offset+p.count,s=p.index,a=r[s].indices.length}else o=0,s=0,a=r[s].indices.length;for(var f=e.length,u=0;u<f;++u){var c=e[u],m=c[t];if(n.defined(m)){var h=m.indices.length;o+h>a&&(o=0,a=r[++s].indices.length),i.push({index:s,offset:o,count:h}),o+=h}}}function y(e,t){var r=[];return g(e,"geometry",t,r),g(e,"westHemisphereGeometry",t,r),g(e,"eastHemisphereGeometry",t,r),r}Object.defineProperties(u.prototype,{componentDatatype:{get:function(){return r.ComponentDatatype.FLOAT}},componentsPerAttribute:{get:function(){return 3}},normalize:{get:function(){return!1}}}),u.fromCartesian3=function(e){return i.Check.defined("offset",e),new u(e.x,e.y,e.z)},u.toValue=function(e,t){return i.Check.defined("offset",e),n.defined(t)||(t=new Float32Array([e.x,e.y,e.z])),t[0]=e.x,t[1]=e.y,t[2]=e.z,t};var v={};function b(e,t){var r=e.attributes;for(var i in r)if(r.hasOwnProperty(i)){var o=r[i];n.defined(o)&&n.defined(o.values)&&t.push(o.values.buffer)}n.defined(e.indices)&&t.push(e.indices.buffer)}function x(e,t){for(var r=e.length,n=0;n<r;++n)b(e[n],t)}function G(e){for(var r=1,i=e.length,o=0;o<i;o++){var a=e[o];if(++r,n.defined(a)){var s=a.attributes;for(var d in r+=7+2*t.BoundingSphere.packedLength+(n.defined(a.indices)?a.indices.length:0),s)if(s.hasOwnProperty(d)&&n.defined(s[d])){var p=s[d];r+=5+p.values.length}}}return r}function S(e,t){var r=e.length,i=new Float64Array(1+19*r),a=0;i[a++]=r;for(var s=0;s<r;s++){var d=e[s];if(o.Matrix4.pack(d.modelMatrix,i,a),a+=o.Matrix4.packedLength,n.defined(d.attributes)&&n.defined(d.attributes.offset)){var p=d.attributes.offset.value;i[a]=p[0],i[a+1]=p[1],i[a+2]=p[2]}a+=3}return t.push(i.buffer),i}function P(e){var t=e,r=new Array(t[0]),i=0,a=1;while(a<t.length){var s,d=o.Matrix4.unpack(t,a);a+=o.Matrix4.packedLength,n.defined(t[a])&&(s={offset:new u(t[a],t[a+1],t[a+2])}),a+=3,r[i++]={modelMatrix:d,attributes:s}}return r}function k(e){var r=e.length,i=1+(t.BoundingSphere.packedLength+1)*r,o=new Float32Array(i),a=0;o[a++]=r;for(var s=0;s<r;++s){var d=e[s];n.defined(d)?(o[a++]=1,t.BoundingSphere.pack(e[s],o,a)):o[a++]=0,a+=t.BoundingSphere.packedLength}return o}function C(e){var r=new Array(e[0]),n=0,i=1;while(i<e.length)1===e[i++]&&(r[n]=t.BoundingSphere.unpack(e,i)),++n,i+=t.BoundingSphere.packedLength;return r}v.combineGeometry=function(e){var r,i,o,a,s=e.instances,p=s.length,f=!1;p>0&&(r=l(e),r.length>0&&(i=d.GeometryPipeline.createAttributeLocations(r[0]),e.createPickOffsets&&(o=y(s,r))),n.defined(s[0].attributes)&&n.defined(s[0].attributes.offset)&&(a=new Array(p),f=!0));for(var u=new Array(p),c=new Array(p),m=0;m<p;++m){var h=s[m],g=h.geometry;n.defined(g)&&(u[m]=g.boundingSphere,c[m]=g.boundingSphereCV,f&&(a[m]=h.geometry.offsetAttribute));var v=h.eastHemisphereGeometry,b=h.westHemisphereGeometry;n.defined(v)&&n.defined(b)&&(n.defined(v.boundingSphere)&&n.defined(b.boundingSphere)&&(u[m]=t.BoundingSphere.union(v.boundingSphere,b.boundingSphere)),n.defined(v.boundingSphereCV)&&n.defined(b.boundingSphereCV)&&(c[m]=t.BoundingSphere.union(v.boundingSphereCV,b.boundingSphereCV)))}return{geometries:r,modelMatrix:e.modelMatrix,attributeLocations:i,pickOffsets:o,offsetInstanceExtend:a,boundingSpheres:u,boundingSpheresCV:c}},v.packCreateGeometryResults=function(e,r){var i=new Float64Array(G(e)),o=[],a={},s=e.length,d=0;i[d++]=s;for(var p=0;p<s;p++){var f=e[p],u=n.defined(f);if(i[d++]=u?1:0,u){i[d++]=f.primitiveType,i[d++]=f.geometryType,i[d++]=n.defaultValue(f.offsetAttribute,-1);var c=n.defined(f.boundingSphere)?1:0;i[d++]=c,c&&t.BoundingSphere.pack(f.boundingSphere,i,d),d+=t.BoundingSphere.packedLength;var m=n.defined(f.boundingSphereCV)?1:0;i[d++]=m,m&&t.BoundingSphere.pack(f.boundingSphereCV,i,d),d+=t.BoundingSphere.packedLength;var h=f.attributes,l=[];for(var g in h)h.hasOwnProperty(g)&&n.defined(h[g])&&(l.push(g),n.defined(a[g])||(a[g]=o.length,o.push(g)));i[d++]=l.length;for(var y=0;y<l.length;y++){var v=l[y],b=h[v];i[d++]=a[v],i[d++]=b.componentDatatype,i[d++]=b.componentsPerAttribute,i[d++]=b.normalize?1:0,i[d++]=b.values.length,i.set(b.values,d),d+=b.values.length}var x=n.defined(f.indices)?f.indices.length:0;i[d++]=x,x>0&&(i.set(f.indices,d),d+=x)}}return r.push(i.buffer),{stringTable:o,packedData:i}},v.unpackCreateGeometryResults=function(e){var n,i=e.stringTable,o=e.packedData,d=new Array(o[0]),f=0,u=1;while(u<o.length){var c=1===o[u++];if(c){var m,h,l=o[u++],g=o[u++],y=o[u++];-1===y&&(y=void 0);var v=1===o[u++];v&&(m=t.BoundingSphere.unpack(o,u)),u+=t.BoundingSphere.packedLength;var b,x,G,S=1===o[u++];S&&(h=t.BoundingSphere.unpack(o,u)),u+=t.BoundingSphere.packedLength;var P,k=new s.GeometryAttributes,C=o[u++];for(n=0;n<C;n++){var w=i[o[u++]],A=o[u++];G=o[u++];var V=0!==o[u++];b=o[u++],x=r.ComponentDatatype.createTypedArray(A,b);for(var D=0;D<b;D++)x[D]=o[u++];k[w]=new a.GeometryAttribute({componentDatatype:A,componentsPerAttribute:G,normalize:V,values:x})}if(b=o[u++],b>0){var O=x.length/G;for(P=p.IndexDatatype.createTypedArray(O,b),n=0;n<b;n++)P[n]=o[u++]}d[f++]=new a.Geometry({primitiveType:l,geometryType:g,boundingSphere:m,boundingSphereCV:h,indices:P,attributes:k,offsetAttribute:y})}else d[f++]=void 0}return d},v.packCombineGeometryParameters=function(e,r){for(var n=e.createGeometryResults,i=n.length,o=0;o<i;o++)r.push(n[o].packedData.buffer);return{createGeometryResults:e.createGeometryResults,packedInstances:S(e.instances,r),ellipsoid:e.ellipsoid,isGeographic:e.projection instanceof t.GeographicProjection,elementIndexUintSupported:e.elementIndexUintSupported,scene3DOnly:e.scene3DOnly,vertexCacheOptimize:e.vertexCacheOptimize,compressVertices:e.compressVertices,modelMatrix:e.modelMatrix,createPickOffsets:e.createPickOffsets}},v.unpackCombineGeometryParameters=function(e){for(var r=P(e.packedInstances),n=e.createGeometryResults,i=n.length,a=0,s=0;s<i;s++)for(var d=v.unpackCreateGeometryResults(n[s]),p=d.length,u=0;u<p;u++){var c=d[u],m=r[a];m.geometry=c,++a}var h=o.Ellipsoid.clone(e.ellipsoid),l=e.isGeographic?new t.GeographicProjection(h):new f.WebMercatorProjection(h);return{instances:r,ellipsoid:h,projection:l,elementIndexUintSupported:e.elementIndexUintSupported,scene3DOnly:e.scene3DOnly,vertexCacheOptimize:e.vertexCacheOptimize,compressVertices:e.compressVertices,modelMatrix:o.Matrix4.clone(e.modelMatrix),createPickOffsets:e.createPickOffsets}},v.packCombineGeometryResults=function(e,t){n.defined(e.geometries)&&x(e.geometries,t);var r=k(e.boundingSpheres),i=k(e.boundingSpheresCV);return t.push(r.buffer,i.buffer),{geometries:e.geometries,attributeLocations:e.attributeLocations,modelMatrix:e.modelMatrix,pickOffsets:e.pickOffsets,offsetInstanceExtend:e.offsetInstanceExtend,boundingSpheres:r,boundingSpheresCV:i}},v.unpackCombineGeometryResults=function(e){return{geometries:e.geometries,attributeLocations:e.attributeLocations,modelMatrix:e.modelMatrix,pickOffsets:e.pickOffsets,offsetInstanceExtend:e.offsetInstanceExtend,boundingSpheres:C(e.boundingSpheres),boundingSpheresCV:C(e.boundingSpheresCV)}},e.PrimitivePipeline=v}));