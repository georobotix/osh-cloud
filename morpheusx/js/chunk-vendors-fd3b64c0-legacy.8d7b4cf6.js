"use strict";(self["webpackChunkvue3_webpack5"]=self["webpackChunkvue3_webpack5"]||[]).push([[1458],{520:function(e,n,t){t.d(n,{Z:function(){return L}});var i=t(82482),s=t(52447),o=t(93844),a=t(43844),r=t(80744),l=t(1418),c=t(49764),p=t(44522),f=t(77910),d=t(52462);async function m(e){const n=[];return e.scenes.forEach((e=>{e.traverse((e=>{Object.values(e.model.getUniforms()).forEach((e=>{!1===e.loaded&&n.push(e)}))}))})),await g((()=>n.some((e=>!e.loaded))))}async function g(e){while(e())await new Promise((e=>requestAnimationFrame(e)))}var u=t(38550),_=t(24088);const h=Math.PI/180,v=new Float32Array(16),M=new Float32Array(12);function y(e,n,t){const i=n[0]*h,s=n[1]*h,o=n[2]*h,a=Math.sin(o),r=Math.sin(i),l=Math.sin(s),c=Math.cos(o),p=Math.cos(i),f=Math.cos(s),d=t[0],m=t[1],g=t[2];e[0]=d*f*p,e[1]=d*l*p,e[2]=d*-r,e[3]=m*(-l*c+f*r*a),e[4]=m*(f*c+l*r*a),e[5]=m*p*a,e[6]=g*(l*a+f*r*c),e[7]=g*(-f*a+l*r*c),e[8]=g*p*c}function O(e){return e[0]=e[0],e[1]=e[1],e[2]=e[2],e[3]=e[4],e[4]=e[5],e[5]=e[6],e[6]=e[8],e[7]=e[9],e[8]=e[10],e[9]=e[12],e[10]=e[13],e[11]=e[14],e.subarray(0,12)}const S={size:12,accessor:["getOrientation","getScale","getTranslation","getTransformMatrix"],shaderAttributes:{instanceModelMatrix__LOCATION_0:{size:3,elementOffset:0},instanceModelMatrix__LOCATION_1:{size:3,elementOffset:3},instanceModelMatrix__LOCATION_2:{size:3,elementOffset:6},instanceTranslation:{size:3,elementOffset:9}},update(e,{startRow:n,endRow:t}){const{data:i,getOrientation:s,getScale:o,getTranslation:a,getTransformMatrix:r}=this.props,l=Array.isArray(r),c=l&&16===r.length,p=Array.isArray(o),f=Array.isArray(s),d=Array.isArray(a),m=c||!l&&Boolean(r(i[0]));e.constant=m?c:f&&p&&d;const g=e.value;if(e.constant){let n;if(m)v.set(r),n=O(v);else{n=M;const e=s,t=o;y(n,e,t),n.set(a,9)}e.value=new Float32Array(n)}else{let l=n*e.size;const{iterable:_,objectInfo:h}=(0,u.jB)(i,n,t);for(const e of _){let n;if(h.index++,m)v.set(c?r:r(e,h)),n=O(v);else{n=M;const t=f?s:s(e,h),i=p?o:o(e,h);y(n,t,i),n.set(d?a:a(e,h),9)}g[l++]=n[0],g[l++]=n[1],g[l++]=n[2],g[l++]=n[3],g[l++]=n[4],g[l++]=n[5],g[l++]=n[6],g[l++]=n[7],g[l++]=n[8],g[l++]=n[9],g[l++]=n[10],g[l++]=n[11]}}}};function A(e,n){return n===_.Df.CARTESIAN||n===_.Df.METER_OFFSETS||n===_.Df.DEFAULT&&!e.isGeospatial}var C="#version 300 es\nin vec3 instancePositions;\nin vec3 instancePositions64Low;\nin vec4 instanceColors;\nin vec3 instancePickingColors;\nin mat3 instanceModelMatrix;\nin vec3 instanceTranslation;\nuniform float sizeScale;\nuniform float sizeMinPixels;\nuniform float sizeMaxPixels;\nuniform mat4 sceneModelMatrix;\nuniform bool composeModelMatrix;\nin vec4 POSITION;\n\n#ifdef HAS_UV\n  in vec2 TEXCOORD_0;\n#endif\n\n#ifdef MODULE_PBR\n  #ifdef HAS_NORMALS\n    in vec4 NORMAL;\n  #endif\n#endif\nout vec4 vColor;\n#ifndef MODULE_PBR\n  #ifdef HAS_UV\n    out vec2 vTEXCOORD_0;\n  #endif\n#endif\nvoid main(void) {\n  #if defined(HAS_UV) && !defined(MODULE_PBR)\n    vTEXCOORD_0 = TEXCOORD_0;\n    geometry.uv = vTEXCOORD_0;\n  #endif\n\n  geometry.worldPosition = instancePositions;\n  geometry.pickingColor = instancePickingColors;\n\n  vec3 normal = vec3(0.0, 0.0, 1.0);\n  #ifdef MODULE_PBR\n    #ifdef HAS_NORMALS\n      normal = instanceModelMatrix * (sceneModelMatrix * vec4(NORMAL.xyz, 0.0)).xyz;\n    #endif\n  #endif\n\n  float originalSize = project_size_to_pixel(sizeScale);\n  float clampedSize = clamp(originalSize, sizeMinPixels, sizeMaxPixels);\n\n  vec3 pos = (instanceModelMatrix * (sceneModelMatrix * POSITION).xyz) * sizeScale * (clampedSize / originalSize) + instanceTranslation;\n  if(composeModelMatrix) {\n    DECKGL_FILTER_SIZE(pos, geometry);\n    geometry.normal = project_normal(normal);\n    geometry.worldPosition += pos;\n    gl_Position = project_position_to_clipspace(pos + instancePositions, instancePositions64Low, vec3(0.0), geometry.position);\n  }\n  else {\n    pos = project_size(pos);\n    DECKGL_FILTER_SIZE(pos, geometry);\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, pos, geometry.position);\n    geometry.normal = project_normal(normal);\n  }\n  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n\n  #ifdef MODULE_PBR\n    pbr_vPosition = geometry.position.xyz;\n    #ifdef HAS_NORMALS\n      pbr_vNormal = geometry.normal;\n    #endif\n\n    #ifdef HAS_UV\n      pbr_vUV = TEXCOORD_0;\n    #else\n      pbr_vUV = vec2(0., 0.);\n    #endif\n    geometry.uv = pbr_vUV;\n  #endif\n\n  vColor = instanceColors;\n  DECKGL_FILTER_COLOR(vColor, geometry);\n}\n",P="#version 300 es\nuniform float opacity;\nin vec4 vColor;\n\nout vec4 fragmentColor;\n#ifndef MODULE_PBR\n  #if defined(HAS_UV) && defined(HAS_BASECOLORMAP)\n    in vec2 vTEXCOORD_0;\n    uniform sampler2D u_BaseColorSampler;\n  #endif\n#endif\n\nvoid main(void) {\n  #ifdef MODULE_PBR\n    fragmentColor = vColor * pbr_filterColor(vec4(0));\n    geometry.uv = pbr_vUV;\n  #else\n    #if defined(HAS_UV) && defined(HAS_BASECOLORMAP)\n      fragmentColor = vColor * texture2D(u_BaseColorSampler, vTEXCOORD_0);\n      geometry.uv = vTEXCOORD_0;\n    #else\n      fragmentColor = vColor;\n    #endif\n  #endif\n\n  fragmentColor.a *= opacity;\n  DECKGL_FILTER_COLOR(fragmentColor, geometry);\n}\n";const x=[255,255,255,255],E={scenegraph:{type:"object",value:null,async:!0},getScene:e=>e&&e.scenes?"object"===typeof e.scene?e.scene:e.scenes[e.scene||0]:e,getAnimator:e=>e&&e.animator,_animations:null,sizeScale:{type:"number",value:1,min:0},sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},getPosition:{type:"accessor",value:e=>e.position},getColor:{type:"accessor",value:x},_lighting:"flat",_imageBasedLightingEnvironment:null,getOrientation:{type:"accessor",value:[0,0,0]},getScale:{type:"accessor",value:[1,1,1]},getTranslation:{type:"accessor",value:[0,0,0]},getTransformMatrix:{type:"accessor",value:[]},loaders:[d.E]};class L extends s.Z{constructor(...e){super(...e),(0,i.Z)(this,"state",void 0)}getShaders(){const e=[o.Z,a.Z];return"pbr"===this.props._lighting&&e.push(c.b),{vs:C,fs:P,modules:e}}initializeState(){const e=this.getAttributeManager();e.addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),accessor:"getPosition",transition:!0},instanceColors:{type:5121,size:this.props.colorFormat.length,accessor:"getColor",normalized:!0,defaultValue:x,transition:!0},instanceModelMatrix:S})}updateState(e){super.updateState(e);const{props:n,oldProps:t}=e;n.scenegraph!==t.scenegraph?this._updateScenegraph():n._animations!==t._animations&&this._applyAnimationsProp(this.state.scenegraph,this.state.animator,n._animations)}finalizeState(e){super.finalizeState(e),this._deleteScenegraph()}_updateScenegraph(){const e=this.props,{gl:n}=this.context;let t=null;if(e.scenegraph instanceof p.Z)t={scenes:[e.scenegraph]};else if(e.scenegraph&&!e.scenegraph.gltf){const i=e.scenegraph,s=(0,f.Z)(n,i,this._getModelOptions());t={gltf:i,...s},m(s).then((()=>this.setNeedsRedraw()))}else e.scenegraph&&(r.Z.deprecated("ScenegraphLayer.props.scenegraph","Use GLTFLoader instead of GLTFScenegraphLoader")(),t=e.scenegraph);const i={layer:this,gl:n},s=e.getScene(t,i),o=e.getAnimator(t,i);s instanceof p.Z?(this._deleteScenegraph(),this._applyAllAttributes(s),this._applyAnimationsProp(s,o,e._animations),this.setState({scenegraph:s,animator:o})):null!==s&&r.Z.warn("invalid scenegraph:",s)()}_applyAllAttributes(e){if(this.state.attributesAvailable){const n=this.getAttributeManager().getAttributes();e.traverse((e=>{this._setModelAttributes(e.model,n)}))}}_applyAnimationsProp(e,n,t){if(!e||!n||!t)return;const i=n.getAnimations();Object.keys(t).sort().forEach((e=>{const n=t[e];if("*"===e)i.forEach((e=>{Object.assign(e,n)}));else if(Number.isFinite(Number(e))){const t=Number(e);t>=0&&t<i.length?Object.assign(i[t],n):r.Z.warn("animation ".concat(e," not found"))()}else{const t=i.find((({name:n})=>n===e));t?Object.assign(t,n):r.Z.warn("animation ".concat(e," not found"))()}}))}_deleteScenegraph(){const{scenegraph:e}=this.state;e instanceof p.Z&&e.delete()}_getModelOptions(){const{_imageBasedLightingEnvironment:e}=this.props;let n=null;return e&&(n="function"===typeof e?e({gl:this.context.gl,layer:this}):e),{gl:this.context.gl,waitForFullLoad:!0,imageBasedLightingEnvironment:n,modelOptions:{isInstanced:!0,transpileToGLSL100:!(0,l.D0)(this.context.gl),...this.getShaders()},useTangents:!1}}updateAttributes(e){this.setState({attributesAvailable:!0}),this.state.scenegraph&&this.state.scenegraph.traverse((n=>{this._setModelAttributes(n.model,e)}))}draw({moduleParameters:e=null,parameters:n={},context:t}){if(!this.state.scenegraph)return;this.props._animations&&this.state.animator&&(this.state.animator.animate(t.timeline.getTime()),this.setNeedsRedraw());const{viewport:i}=this.context,{sizeScale:s,sizeMinPixels:o,sizeMaxPixels:a,opacity:r,coordinateSystem:l}=this.props,c=this.getNumInstances();this.state.scenegraph.traverse(((t,{worldMatrix:p})=>{t.model.setInstanceCount(c),t.updateModuleSettings(e),t.draw({parameters:n,uniforms:{sizeScale:s,opacity:r,sizeMinPixels:o,sizeMaxPixels:a,composeModelMatrix:A(i,l),sceneModelMatrix:p,u_Camera:t.model.getUniforms().project_uCameraPosition}})}))}}(0,i.Z)(L,"defaultProps",E),(0,i.Z)(L,"layerName","ScenegraphLayer")}}]);
//# sourceMappingURL=chunk-vendors-fd3b64c0-legacy.8d7b4cf6.js.map