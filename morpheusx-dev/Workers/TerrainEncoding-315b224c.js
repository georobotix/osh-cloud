define(["exports","./Transforms-62a339c3","./Matrix2-92b7fb9d","./RuntimeError-4fdc4459","./when-8166c7dd","./AttributeCompression-212262a3","./ComponentDatatype-9ed50558"],(function(e,t,i,a,r,o,n){"use strict";function s(e,t){a.Check.typeOf.object("ellipsoid",e),this._ellipsoid=e,this._cameraPosition=new i.Cartesian3,this._cameraPositionInScaledSpace=new i.Cartesian3,this._distanceToLimbInScaledSpaceSquared=0,r.defined(t)&&(this.cameraPosition=t)}Object.defineProperties(s.prototype,{ellipsoid:{get:function(){return this._ellipsoid}},cameraPosition:{get:function(){return this._cameraPosition},set:function(e){var t=this._ellipsoid,a=t.transformPositionToScaledSpace(e,this._cameraPositionInScaledSpace),r=i.Cartesian3.magnitudeSquared(a)-1;i.Cartesian3.clone(e,this._cameraPosition),this._cameraPositionInScaledSpace=a,this._distanceToLimbInScaledSpaceSquared=r}}});var c=new i.Cartesian3;s.prototype.isPointVisible=function(e){var t=this._ellipsoid,i=t.transformPositionToScaledSpace(e,c);return C(i,this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared)},s.prototype.isScaledSpacePointVisible=function(e){return C(e,this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared)};var d=new i.Cartesian3;s.prototype.isScaledSpacePointVisiblePossiblyUnderEllipsoid=function(e,t){var i,a,o=this._ellipsoid;return r.defined(t)&&t<0&&o.minimumRadius>-t?(a=d,a.x=this._cameraPosition.x/(o.radii.x+t),a.y=this._cameraPosition.y/(o.radii.y+t),a.z=this._cameraPosition.z/(o.radii.z+t),i=a.x*a.x+a.y*a.y+a.z*a.z-1):(a=this._cameraPositionInScaledSpace,i=this._distanceToLimbInScaledSpaceSquared),C(e,a,i)},s.prototype.computeHorizonCullingPoint=function(e,t,i){return f(this._ellipsoid,e,t,i)};var u=i.Ellipsoid.clone(i.Ellipsoid.UNIT_SPHERE);s.prototype.computeHorizonCullingPointPossiblyUnderEllipsoid=function(e,t,i,a){var r=h(this._ellipsoid,i,u);return f(r,e,t,a)},s.prototype.computeHorizonCullingPointFromVertices=function(e,t,i,a,r){return x(this._ellipsoid,e,t,i,a,r)},s.prototype.computeHorizonCullingPointFromVerticesPossiblyUnderEllipsoid=function(e,t,i,a,r,o){var n=h(this._ellipsoid,r,u);return x(n,e,t,i,a,o)};var m=[];s.prototype.computeHorizonCullingPointFromRectangle=function(e,r,o){a.Check.typeOf.object("rectangle",e);var n=i.Rectangle.subsample(e,r,0,m),s=t.BoundingSphere.fromPoints(n);if(!(i.Cartesian3.magnitude(s.center)<.1*r.minimumRadius))return this.computeHorizonCullingPoint(s.center,n,o)};var l=new i.Cartesian3;function h(e,t,a){if(r.defined(t)&&t<0&&e.minimumRadius>-t){var o=i.Cartesian3.fromElements(e.radii.x+t,e.radii.y+t,e.radii.z+t,l);e=i.Ellipsoid.fromCartesian3(o,a)}return e}function f(e,t,o,n){a.Check.typeOf.object("directionToPoint",t),a.Check.defined("positions",o),r.defined(n)||(n=new i.Cartesian3);for(var s=b(e,t),c=0,d=0,u=o.length;d<u;++d){var m=o[d],l=y(e,m,s);if(l<0)return;c=Math.max(c,l)}return v(s,c,n)}var p=new i.Cartesian3;function x(e,t,o,n,s,c){a.Check.typeOf.object("directionToPoint",t),a.Check.defined("vertices",o),a.Check.typeOf.number("stride",n),r.defined(c)||(c=new i.Cartesian3),n=r.defaultValue(n,3),s=r.defaultValue(s,i.Cartesian3.ZERO);for(var d=b(e,t),u=0,m=0,l=o.length;m<l;m+=n){p.x=o[m]+s.x,p.y=o[m+1]+s.y,p.z=o[m+2]+s.z;var h=y(e,p,d);if(h<0)return;u=Math.max(u,h)}return v(d,u,c)}function C(e,t,a){var r=t,o=a,n=i.Cartesian3.subtract(e,r,c),s=-i.Cartesian3.dot(n,r),d=o<0?s>0:s>o&&s*s/i.Cartesian3.magnitudeSquared(n)>o;return!d}var S=new i.Cartesian3,g=new i.Cartesian3;function y(e,t,a){var r=e.transformPositionToScaledSpace(t,S),o=i.Cartesian3.magnitudeSquared(r),n=Math.sqrt(o),s=i.Cartesian3.divideByScalar(r,n,g);o=Math.max(1,o),n=Math.max(1,n);var c=i.Cartesian3.dot(s,a),d=i.Cartesian3.magnitude(i.Cartesian3.cross(s,a,s)),u=1/n,m=Math.sqrt(o-1)*u;return 1/(c*u-d*m)}function v(e,t,a){if(!(t<=0||t===1/0||t!==t))return i.Cartesian3.multiplyByScalar(e,t,a)}var N=new i.Cartesian3;function b(e,t){return i.Cartesian3.equals(t,i.Cartesian3.ZERO)?t:(e.transformPositionToScaledSpace(t,N),i.Cartesian3.normalize(N,N))}var T={getHeight:function(e,t,i){return(e-i)*t+i}},M=new i.Cartesian3;T.getPosition=function(e,t,a,r,o){var n=t.cartesianToCartographic(e,M),s=T.getHeight(n.height,a,r);return i.Cartesian3.fromRadians(n.longitude,n.latitude,s,t,o)};var P={NONE:0,BITS12:1},z=Object.freeze(P),_=new i.Cartesian3,E=new i.Cartesian3,H=new i.Cartesian2,w=new i.Matrix4,A=new i.Matrix4,I=Math.pow(2,12);function O(e,t,a,o,n,s,c,d,u,m){var l,h,f=z.NONE;if(r.defined(t)&&r.defined(a)&&r.defined(o)&&r.defined(n)){var p=t.minimum,x=t.maximum,C=i.Cartesian3.subtract(x,p,E),S=o-a,g=Math.max(i.Cartesian3.maximumComponent(C),S);f=g<I-1?z.BITS12:z.NONE,l=i.Matrix4.inverseTransformation(n,new i.Matrix4);var y=i.Cartesian3.negate(p,_);i.Matrix4.multiply(i.Matrix4.fromTranslation(y,w),l,l);var v=_;v.x=1/C.x,v.y=1/C.y,v.z=1/C.z,i.Matrix4.multiply(i.Matrix4.fromScale(v,w),l,l),h=i.Matrix4.clone(n),i.Matrix4.setTranslation(h,i.Cartesian3.ZERO,h),n=i.Matrix4.clone(n,new i.Matrix4);var N=i.Matrix4.fromTranslation(p,w),b=i.Matrix4.fromScale(C,A),T=i.Matrix4.multiply(N,b,w);i.Matrix4.multiply(n,T,n),i.Matrix4.multiply(h,T,h)}this.quantization=f,this.minimumHeight=a,this.maximumHeight=o,this.center=i.Cartesian3.clone(e),this.toScaledENU=l,this.fromScaledENU=n,this.matrix=h,this.hasVertexNormals=s,this.hasWebMercatorT=r.defaultValue(c,!1),this.hasGeodeticSurfaceNormals=r.defaultValue(d,!1),this.exaggeration=r.defaultValue(u,1),this.exaggerationRelativeHeight=r.defaultValue(m,0),this.stride=0,this._offsetGeodeticSurfaceNormal=0,this._offsetVertexNormal=0,this._calculateStrideAndOffsets()}O.prototype.encode=function(e,t,a,r,s,c,d,u){var m=r.x,l=r.y;if(this.quantization===z.BITS12){a=i.Matrix4.multiplyByPoint(this.toScaledENU,a,_),a.x=n.CesiumMath.clamp(a.x,0,1),a.y=n.CesiumMath.clamp(a.y,0,1),a.z=n.CesiumMath.clamp(a.z,0,1);var h=this.maximumHeight-this.minimumHeight,f=n.CesiumMath.clamp((s-this.minimumHeight)/h,0,1);i.Cartesian2.fromElements(a.x,a.y,H);var p=o.AttributeCompression.compressTextureCoordinates(H);i.Cartesian2.fromElements(a.z,f,H);var x=o.AttributeCompression.compressTextureCoordinates(H);i.Cartesian2.fromElements(m,l,H);var C=o.AttributeCompression.compressTextureCoordinates(H);if(e[t++]=p,e[t++]=x,e[t++]=C,this.hasWebMercatorT){i.Cartesian2.fromElements(d,0,H);var S=o.AttributeCompression.compressTextureCoordinates(H);e[t++]=S}}else i.Cartesian3.subtract(a,this.center,_),e[t++]=_.x,e[t++]=_.y,e[t++]=_.z,e[t++]=s,e[t++]=m,e[t++]=l,this.hasWebMercatorT&&(e[t++]=d);return this.hasVertexNormals&&(e[t++]=o.AttributeCompression.octPackFloat(c)),this.hasGeodeticSurfaceNormals&&(e[t++]=u.x,e[t++]=u.y,e[t++]=u.z),t};var q=new i.Cartesian3,V=new i.Cartesian3;O.prototype.addGeodeticSurfaceNormals=function(e,t,i){if(!this.hasGeodeticSurfaceNormals){var a=this.stride,r=e.length/a;this.hasGeodeticSurfaceNormals=!0,this._calculateStrideAndOffsets();for(var o=this.stride,n=0;n<r;n++){for(var s=0;s<a;s++){var c=n*a+s,d=n*o+s;t[d]=e[c]}var u=this.decodePosition(t,n,q),m=i.geodeticSurfaceNormal(u,V),l=n*o+this._offsetGeodeticSurfaceNormal;t[l]=m.x,t[l+1]=m.y,t[l+2]=m.z}}},O.prototype.removeGeodeticSurfaceNormals=function(e,t){if(this.hasGeodeticSurfaceNormals){var i=this.stride,a=e.length/i;this.hasGeodeticSurfaceNormals=!1,this._calculateStrideAndOffsets();for(var r=this.stride,o=0;o<a;o++)for(var n=0;n<r;n++){var s=o*i+n,c=o*r+n;t[c]=e[s]}}},O.prototype.decodePosition=function(e,t,a){if(r.defined(a)||(a=new i.Cartesian3),t*=this.stride,this.quantization===z.BITS12){var n=o.AttributeCompression.decompressTextureCoordinates(e[t],H);a.x=n.x,a.y=n.y;var s=o.AttributeCompression.decompressTextureCoordinates(e[t+1],H);return a.z=s.x,i.Matrix4.multiplyByPoint(this.fromScaledENU,a,a)}return a.x=e[t],a.y=e[t+1],a.z=e[t+2],i.Cartesian3.add(a,this.center,a)},O.prototype.getExaggeratedPosition=function(e,t,i){i=this.decodePosition(e,t,i);var a=this.exaggeration,r=this.exaggerationRelativeHeight,o=1!==a;if(o&&this.hasGeodeticSurfaceNormals){var n=this.decodeGeodeticSurfaceNormal(e,t,V),s=this.decodeHeight(e,t),c=T.getHeight(s,a,r)-s;i.x+=n.x*c,i.y+=n.y*c,i.z+=n.z*c}return i},O.prototype.decodeTextureCoordinates=function(e,t,a){return r.defined(a)||(a=new i.Cartesian2),t*=this.stride,this.quantization===z.BITS12?o.AttributeCompression.decompressTextureCoordinates(e[t+2],a):i.Cartesian2.fromElements(e[t+4],e[t+5],a)},O.prototype.decodeHeight=function(e,t){if(t*=this.stride,this.quantization===z.BITS12){var i=o.AttributeCompression.decompressTextureCoordinates(e[t+1],H);return i.y*(this.maximumHeight-this.minimumHeight)+this.minimumHeight}return e[t+3]},O.prototype.decodeWebMercatorT=function(e,t){return t*=this.stride,this.quantization===z.BITS12?o.AttributeCompression.decompressTextureCoordinates(e[t+3],H).x:e[t+6]},O.prototype.getOctEncodedNormal=function(e,t,a){t=t*this.stride+this._offsetVertexNormal;var r=e[t]/256,o=Math.floor(r),n=256*(r-o);return i.Cartesian2.fromElements(o,n,a)},O.prototype.decodeGeodeticSurfaceNormal=function(e,t,i){return t=t*this.stride+this._offsetGeodeticSurfaceNormal,i.x=e[t],i.y=e[t+1],i.z=e[t+2],i},O.prototype._calculateStrideAndOffsets=function(){var e=0;switch(this.quantization){case z.BITS12:e+=3;break;default:e+=6}this.hasWebMercatorT&&(e+=1),this.hasVertexNormals&&(this._offsetVertexNormal=e,e+=1),this.hasGeodeticSurfaceNormals&&(this._offsetGeodeticSurfaceNormal=e,e+=3),this.stride=e};var G={position3DAndHeight:0,textureCoordAndEncodedNormals:1,geodeticSurfaceNormal:2},B={compressed0:0,compressed1:1,geodeticSurfaceNormal:2};O.prototype.getAttributes=function(e){var t=n.ComponentDatatype.FLOAT,i=n.ComponentDatatype.getSizeInBytes(t),a=this.stride*i,r=0,o=[];function s(n,s){o.push({index:n,vertexBuffer:e,componentDatatype:t,componentsPerAttribute:s,offsetInBytes:r,strideInBytes:a}),r+=s*i}if(this.quantization===z.NONE){s(G.position3DAndHeight,4);var c=2;c+=this.hasWebMercatorT?1:0,c+=this.hasVertexNormals?1:0,s(G.textureCoordAndEncodedNormals,c),this.hasGeodeticSurfaceNormals&&s(G.geodeticSurfaceNormal,3)}else{var d=this.hasWebMercatorT||this.hasVertexNormals,u=this.hasWebMercatorT&&this.hasVertexNormals;s(B.compressed0,d?4:3),u&&s(B.compressed1,1),this.hasGeodeticSurfaceNormals&&s(B.geodeticSurfaceNormal,3)}return o},O.prototype.getAttributeLocations=function(){return this.quantization===z.NONE?G:B},O.clone=function(e,t){if(r.defined(e))return r.defined(t)||(t=new O),t.quantization=e.quantization,t.minimumHeight=e.minimumHeight,t.maximumHeight=e.maximumHeight,t.center=i.Cartesian3.clone(e.center),t.toScaledENU=i.Matrix4.clone(e.toScaledENU),t.fromScaledENU=i.Matrix4.clone(e.fromScaledENU),t.matrix=i.Matrix4.clone(e.matrix),t.hasVertexNormals=e.hasVertexNormals,t.hasWebMercatorT=e.hasWebMercatorT,t.hasGeodeticSurfaceNormals=e.hasGeodeticSurfaceNormals,t.exaggeration=e.exaggeration,t.exaggerationRelativeHeight=e.exaggerationRelativeHeight,t._calculateStrideAndOffsets(),t},e.EllipsoidalOccluder=s,e.TerrainEncoding=O}));